{% extends "base.html" %}
{% block title %}Grid Inference Worker â€” Settings{% endblock %}
{% block nav_settings %}active{% endblock %}

{% block content %}
<div x-data="settingsForm()">
  <div class="page-header">
    <h1>Settings</h1>
  </div>

  <form @submit.prevent="save()" class="settings-form">
    <div class="card">
      <h2>Grid API</h2>
      <label class="field">
        <span class="field-label">API Key</span>
        <input type="password" x-model="form.GRID_API_KEY" placeholder="Your AI Power Grid API key">
      </label>
      <label class="field" style="margin-bottom: 0;">
        <span class="field-label">Worker Name</span>
        <input type="text" x-model="form.GRID_WORKER_NAME" placeholder="Text-Inference-Worker">
      </label>
    </div>

    <div class="card">
      <h2>Backend</h2>
      <label class="field">
        <span class="field-label">Backend Type</span>
        <select x-model="form.BACKEND_TYPE">
          <option value="ollama">Ollama</option>
          <option value="openai">OpenAI-compatible (vLLM, SGLang, etc.)</option>
        </select>
      </label>
      <label class="field" x-show="form.BACKEND_TYPE === 'ollama'" style="margin-bottom: 0;">
        <span class="field-label">Ollama URL</span>
        <input type="text" x-model="form.OLLAMA_URL" placeholder="http://127.0.0.1:11434">
      </label>
      <template x-if="form.BACKEND_TYPE === 'openai'">
        <div>
          <label class="field">
            <span class="field-label">OpenAI-compatible URL</span>
            <input type="text" x-model="form.OPENAI_URL" placeholder="http://127.0.0.1:8000/v1">
          </label>
          <label class="field" style="margin-bottom: 0;">
            <span class="field-label">API Key <span class="optional">(if required)</span></span>
            <input type="password" x-model="form.OPENAI_API_KEY" placeholder="">
          </label>
        </div>
      </template>
    </div>

    <div class="card">
      <h2>Model</h2>
      <label class="field">
        <span class="field-label">Model Name</span>
        <input type="text" x-model="form.MODEL_NAME" placeholder="e.g. llama3.2:3b">
        <div class="field-hint">The model your backend is serving.</div>
      </label>
      <label class="field" style="margin-bottom: 0;">
        <span class="field-label">Grid Model Name <span class="optional">(what to advertise)</span></span>
        <input type="text" x-model="form.GRID_MODEL_NAME" placeholder="e.g. gridbridge/llama3.2:3b">
        <div class="field-hint">Leave blank to auto-generate from model name.</div>
      </label>
    </div>

    <div class="card">
      <h2>Limits</h2>
      <label class="field">
        <span class="field-label">Max Threads</span>
        <input type="number" x-model="form.GRID_MAX_THREADS" min="1" max="16">
      </label>
      <label class="field">
        <span class="field-label">Max Length (tokens)</span>
        <div style="display: flex; align-items: center; gap: 0.75rem;">
          <input type="range" x-model="form.GRID_MAX_LENGTH" min="64" max="4096" step="64"
                 style="flex: 1; accent-color: var(--accent);">
          <span style="min-width: 3.5rem; text-align: right; font-size: 0.85rem; font-family: monospace; color: var(--text);"
                x-text="form.GRID_MAX_LENGTH"></span>
        </div>
      </label>
      <label class="field">
        <span class="field-label">Max Context Length (tokens)</span>
        <input type="number" x-model="form.GRID_MAX_CONTEXT_LENGTH" min="256" max="131072">
      </label>
      <label class="checkbox-label">
        <input type="checkbox" :checked="form.GRID_NSFW === 'true'" @change="form.GRID_NSFW = $event.target.checked ? 'true' : 'false'">
        Allow NSFW
      </label>
    </div>

    <div class="card wallet-card">
      <div class="wallet-header">
        <h2>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--accent);"><path d="M21 12V7H5a2 2 0 010-4h14v4"/><path d="M3 5v14a2 2 0 002 2h16v-5"/><path d="M18 12a2 2 0 100 4h4v-4h-4z"/></svg>
          Wallet
        </h2>
        <span class="chain-badge">
          <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>
          Base
        </span>
      </div>
      <div class="wallet-body">
        <!-- Not connected -->
        <template x-if="!form.WALLET_ADDRESS">
          <div>
            <p class="field-hint" style="margin-bottom: 0.85rem;">Connect your wallet or paste an address to receive worker rewards.</p>
            <button type="button" class="btn-connect" @click="connectWallet()">
              <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 010-4h14v4"/><path d="M3 5v14a2 2 0 002 2h16v-5"/><path d="M18 12a2 2 0 100 4h4v-4h-4z"/></svg>
              Connect Wallet
            </button>
            <p class="wallet-hint" x-show="wallet_hint" x-text="wallet_hint"></p>
          </div>
        </template>

        <!-- Connected -->
        <template x-if="form.WALLET_ADDRESS">
          <div>
            <div class="wallet-connected">
              <div class="address-pill" :class="walletValid ? 'valid' : 'invalid'">
                <span class="status-dot"></span>
                <span class="address-text" x-text="form.WALLET_ADDRESS.slice(0,6) + '...' + form.WALLET_ADDRESS.slice(-4)"></span>
              </div>
              <button type="button" class="btn-clear" @click="form.WALLET_ADDRESS = ''">Clear</button>
            </div>
            <p class="field-hint" style="margin-top: 0.5rem;" x-show="!walletValid">Invalid address format &mdash; must be 0x + 40 hex characters.</p>
          </div>
        </template>

        <div class="wallet-divider">or paste address</div>
        <label class="field" style="margin-bottom: 0;">
          <input type="text" x-model="form.WALLET_ADDRESS" placeholder="0x..." spellcheck="false" autocomplete="off">
        </label>
      </div>
    </div>

    <div class="form-actions" style="justify-content: center;">
      <button type="submit" class="btn btn-primary" :disabled="saving">
        <span x-show="!saving">Save Settings</span>
        <span x-show="saving">Saving...</span>
      </button>
      <span x-show="saved" class="save-ok" x-transition>Saved. Restart worker to apply.</span>
    </div>
  </form>
</div>

<script>
function settingsForm() {
  return {
    saving: false,
    saved: false,
    wallet_hint: '',
    form: {
      GRID_API_KEY: '{{ settings.GRID_API_KEY }}',
      GRID_WORKER_NAME: '{{ settings.GRID_WORKER_NAME }}',
      BACKEND_TYPE: '{{ settings.BACKEND_TYPE }}',
      OLLAMA_URL: '{{ settings.OLLAMA_URL }}',
      OPENAI_URL: '{{ settings.OPENAI_URL }}',
      OPENAI_API_KEY: '{{ settings.OPENAI_API_KEY }}',
      MODEL_NAME: '{{ settings.MODEL_NAME }}',
      GRID_MODEL_NAME: '{{ settings.GRID_MODEL_NAME }}',
      GRID_NSFW: '{{ settings.GRID_NSFW }}',
      GRID_MAX_THREADS: '{{ settings.GRID_MAX_THREADS }}',
      GRID_MAX_LENGTH: '{{ settings.GRID_MAX_LENGTH }}',
      GRID_MAX_CONTEXT_LENGTH: '{{ settings.GRID_MAX_CONTEXT_LENGTH }}',
      WALLET_ADDRESS: '{{ settings.WALLET_ADDRESS }}',
    },
    get walletValid() {
      return /^0x[0-9a-fA-F]{40}$/.test(this.form.WALLET_ADDRESS);
    },
    async connectWallet() {
      this.wallet_hint = '';
      if (!window.ethereum) {
        this.wallet_hint = 'No wallet detected \u2014 paste your address below';
        return;
      }
      try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        this.form.WALLET_ADDRESS = accounts[0];
        try {
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: '0x2105' }],
          });
        } catch (e) {
          if (e.code === 4902) {
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [{ chainId: '0x2105', chainName: 'Base',
                         nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
                         rpcUrls: ['https://mainnet.base.org'],
                         blockExplorerUrls: ['https://basescan.org'] }],
            });
          }
        }
      } catch (e) {
        this.wallet_hint = 'Connection rejected';
      }
    },
    async save() {
      this.saving = true;
      this.saved = false;
      try {
        const r = await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(this.form),
        });
        if (r.ok) this.saved = true;
      } finally {
        this.saving = false;
      }
    }
  }
}
</script>
{% endblock %}
